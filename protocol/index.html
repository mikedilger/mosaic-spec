<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Core Protocol - Mosaic</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Core Protocol";
        var mkdocs_page_input_path = "protocol.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../img/favicon-96x96.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Mosaic Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../status/">Status and Development</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Mosaic Core</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >Identity</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../cryptography/">Cryptography</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../identity/">Identity</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Record Type</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../timestamps/">Timestamps</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../record/">Record Format</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../human_readable_content/">Human Readable Content</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../core_tags/">Core Tags</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../reference/">References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Core Records</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../keyschedule/">Key Schedule Record</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../profile/">Profile Record</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Protocol</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../filter/">Filter</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Core Protocol</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Registries</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../tag_types/">Tag Type Registry</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../kinds/">Record Kind Registry</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mosaic Accessory</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../human_encodings/">Human Encodings</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mosaic Transport</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../websockets/">WebSockets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../webtransport/">WebTransport</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Extensions</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../sync_protocol_extension/">Sync Protocol Extension</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Applications</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Mosaic Social media</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../microblog/">Microblogging</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../blog/">Blog</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../reply_comment/">Reply Comment</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../chat/">Chat</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Mosaic</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Mosaic Core</li>
          <li class="breadcrumb-item">Protocol</li>
      <li class="breadcrumb-item active">Core Protocol</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="protocol">Protocol</h1>
<p><status>PAGE STATUS: early draft</status></p>
<p>Protocol message are not separately digitally signed due to the TLS
transport and certificate authentication.</p>
<h2 id="protocol-extensions">Protocol Extensions</h2>
<p>Protocol extension negotiation is done on a transport-by-transport level.
For <a href="../websockets/">WebSockets</a> transport (the default) this is done with
the <code>X-Mosaic-Extensions</code> header.</p>
<p>The following extensions have been defined:</p>
<ul>
<li><a href="../sync_protocol_extension/">Sync Protocol Extension</a></li>
</ul>
<h2 id="asynchronous">Asynchronous</h2>
<p>All client messages initiate an action, and all server messages are in
response to client messages (NOTE: this may not apply to Mosaic
extensions). Yet messaging is asychronous and both sides SHOULD be
prepared to deal with a message sent at any time.</p>
<p>Servers SHOULD not send messages until they receive a message that
requires a response.</p>
<p>If a server fails to receive a message from a client that does not
have an open query or submission within a reasonable timeframe, it
MAY close the connection.</p>
<p>If a client receives a server message that was not expected, it MUST
ignore it and decide what to do next. In some cases, clients MAY close
the connection because the service they were seeking failed. In other
cases they MAY try something else. There is no provision for a client
to alert a server of an error.</p>
<h2 id="messages">Messages</h2>
<p>Every message starts with a one-byte type, shown below in the header
of each type. Following this is the data of the message.</p>
<table>
<thead>
<tr>
<th>Initiator</th>
<th>Message</th>
</tr>
</thead>
<tbody>
<tr>
<td>Client</td>
<td><a href="#query">Query</a></td>
</tr>
<tr>
<td>Client</td>
<td><a href="#close-query">Close Query</a></td>
</tr>
<tr>
<td>Client</td>
<td><a href="#submission">Submission</a></td>
</tr>
<tr>
<td>Server</td>
<td><a href="#record">Record</a></td>
</tr>
<tr>
<td>Server</td>
<td><a href="#query-complete">Query Complete</a></td>
</tr>
<tr>
<td>Server</td>
<td><a href="#query-closed">Query Closed</a></td>
</tr>
<tr>
<td>Server</td>
<td><a href="#submission-result">Submission Result</a></td>
</tr>
</tbody>
</table>
<h2 id="client-messages">Client messages</h2>
<h3 id="query">Query</h3>
<blockquote>
<p><strong>0x1</strong></p>
</blockquote>
<p>This is a query for records in the following format:</p>
<pre><code class="language-text">                    1       2       3
    0       8       6       4       2
 0  +-------------------------------+
    |  0x1  |   QUERY_ID    | 0x0   |
    +-------------------------------+
    |  FILTER LEN   | 0x0           |
    +-------------------------------+
    |  FILTER ...                   |
    |  ...                          |
    +-------------------------------+
</code></pre>
<p>The <code>QUERY_ID</code> should be made up by the client. It can be any 16-bit
number and is used for associating responses.</p>
<p><code>FILTER_LEN</code> is a 16-bit little-endian integer indicating the length
of the filter.</p>
<p>The <code>FILTER</code> is defined in <a href="../filter/">filter</a>.</p>
<p>This is a client initiated message. Servers are expected to reply with:</p>
<ul>
<li>a series of zero or more <a href="#record"><code>Record</code></a> messages representing all
  the matching records on the server initially, followed by
  a <a href="#query-complete"><code>Query Complete</code></a> message, potentially followed by zero or
  more <a href="#record"><code>Record</code></a> messages that flow in to the server after
  the initial response (so long as the query is still open), or</li>
<li>a <a href="#query-closed"><code>Query Closed</code></a> message if the query could not be served.</li>
</ul>
<p>Queries MUST return results in anti-chronological order, from most
recent backwards.</p>
<h3 id="close-query">Close Query</h3>
<blockquote>
<p><strong>0x2</strong></p>
</blockquote>
<p>This is a client request to close a query in the following format:</p>
<pre><code class="language-text">                    1       2       3
    0       8       6       4       2
 0  +-------------------------------+
    |  0x2  |   QUERY_ID    | 0x0   |
    +-------------------------------+
</code></pre>
<p>This is a client initiated message. Servers are expected to reply with:</p>
<ul>
<li><a href="#query-closed"><code>Query Closed</code></a></li>
</ul>
<h3 id="submission">Submission</h3>
<blockquote>
<p><strong>0x3</strong></p>
</blockquote>
<p>This is the submission of a record in the following format:</p>
<pre><code class="language-text">                    1       2       3
    0       8       6       4       2
 0  +-------------------------------+
    |  0x3  |   LENGTH              |
    +-------------------------------+
    | RECORD ...                    |
    | ...                           |
    +-------------------------------+
</code></pre>
<p><code>LENGTH</code> is a 24-bit little-endian length, with a maximum value of the max
length of a record (1024576 bytes) and representing the actual length of the
subsequent record submitted.</p>
<p><code>RECORD</code> is the record.</p>
<p>This is a client initiated message. Servers are expected to reply with:</p>
<ul>
<li><a href="#submission-result"><code>Submission Result</code></a> with an id prefix matching the record.</li>
</ul>
<h2 id="server-messages">Server messages</h2>
<h3 id="record">Record</h3>
<blockquote>
<p><strong>0x80</strong></p>
</blockquote>
<p>This is a record returned from a query in the following format:</p>
<pre><code class="language-text">                    1       2       3
    0       8       6       4       2
 0  +-------------------------------+
    |  0x80 |   QUERY_ID    | 0x0   |
    +-------------------------------+
    |  0x0  |   LENGTH              |
    +-------------------------------+
    | RECORD ...                    |
    | ...                           |
    +-------------------------------+
</code></pre>
<p>The <code>QUERY_ID</code> is the client query that this record matched.</p>
<p>The <code>LENGTH</code> is the length of the record as a 24-bit little-endian
encoded value.</p>
<p>The <code>RECORD</code> is the actual record</p>
<p>This is a server response message in response to <a href="#query"><code>Query</code></a>.</p>
<h3 id="query-complete">Query Complete</h3>
<blockquote>
<p><strong>0x81</strong></p>
</blockquote>
<p>This is a message indicating that a query is complete, in the following
format:</p>
<pre><code class="language-text">                    1       2       3
    0       8       6       4       2
 0  +-------------------------------+
    |  0x81 |   QUERY_ID    | 0x0   |
    +-------------------------------+
</code></pre>
<p>This indicates that a query is complete. This does not mean the query will
close, as subsequently received records that match the query will be
subsequently returned.</p>
<p>This is a server response message in response to <a href="#query"><code>Query</code></a>.</p>
<h3 id="query-closed">Query Closed</h3>
<blockquote>
<p><strong>0x82</strong></p>
</blockquote>
<p>This is a message indicating that a query has been closed, in the following
format:</p>
<pre><code class="language-text">                    1       2       3
    0       8       6       4       2
 0  +-------------------------------+
    |  0x82 |   QUERY_ID    | CODE  |
    +-------------------------------+
</code></pre>
<p>The <code>QUERY_ID</code> is the client query that is being closed that was
previously supplied by the client in a <a href="#query"><code>Query</code></a>.</p>
<p>The <code>CODE</code> indicates the reason for closure, from among the following
defined reasons.</p>
<ul>
<li><code>ON_REQUEST</code>: 0x1 - In response to <a href="#close-query"><code>Close Query</code></a></li>
<li><code>REJECTED_INVALID</code>: 0x10 - Query was rejected due to being invalid</li>
<li><code>REJECTED_TOO_OPEN</code>: 0x11 - Query was rejected due to being too open
   (scraping too many records)</li>
<li><code>REJECTED_TOO_FAST</code>: 0x12 - Query was rejected due to too many queries
   (or messages of any type) being submitted recently by this client</li>
<li><code>REJECTED_TEMP_BANNED</code>: 0x13 - Query was rejected due to the client
   beint temporarily banned</li>
<li><code>REJECTED_PERM_BANNED</code>: 0x14 - Query was rejected due to the client
   beint permanently banned</li>
<li><code>SHUTTING_DOWN</code>: 0x30 - The server is shutting down</li>
<li><code>INTERNAL_ERROR</code>: 0xF0 - A server error occured</li>
<li><code>OTHER</code>: 0xFF - Some other reason</li>
</ul>
<h3 id="submission-result">Submission Result</h3>
<blockquote>
<p><strong>0x83</strong></p>
</blockquote>
<p>This is a message returning the result of a <a href="#submission">Submission</a> in
the following format:</p>
<pre><code class="language-text">                    1       2       3
    0       8       6       4       2
 0  +-------------------------------+
    |  0x83 |  0x0  |  0x0  |  CODE |
    +-------------------------------+
    |  ID PREFIX 1/8                |
    +-------------------------------+
    |  ID PREFIX 2/8                |
    +-------------------------------+
    |  ID PREFIX 3/8                |
    +-------------------------------+
    |  ID PREFIX 4/8                |
    +-------------------------------+
    |  ID PREFIX 5/8                |
    +-------------------------------+
    |  ID PREFIX 6/8                |
    +-------------------------------+
    |  ID PREFIX 7/8                |
    +-------------------------------+
    |  ID PREFIX 8/8                |
    +-------------------------------+
</code></pre>
<p>The <code>CODE</code> indicates the result of the submission from among the following
defined results:</p>
<ul>
<li><code>OK</code>: 0x1 - Record submission was accepted</li>
<li><code>DUPLICATE</code>: 0x2 - Record is a duplicate. Servers may use this or
  they may optionally use <code>OK</code> in the same circumstance.</li>
<li><code>REJECTED_INVALID</code>: 0x10 - Record is invalid</li>
<li><code>REJECTED_TOO_FAST</code>: 0x12 - Record submission was rejected due to too many
   submissions (or messages of any type) being made recently by this client</li>
<li><code>REJECTED_TEMP_BANNED</code>: 0x13 - Record submission was rejected due to the
   client being temporarily banned</li>
<li><code>REJECTED_PERM_BANNED</code>: 0x14 - Record submission was rejected due to the
   client being permanently banned</li>
<li><code>REJECTED_REQUIRES_AUTHN</code>: 0x15 - Record submission requires authentication
   but the client is connected anonymously.</li>
<li><code>REJECTED_REQUIRES_AUTHZ</code>: 0x16 - Record submission requires authorization
   (e.g. an account with the server) which the client user does not have.</li>
<li><code>INTERNAL_ERROR</code>: 0xF0 - A server error occured</li>
<li><code>OTHER</code>: 0xFF - Some other reason</li>
</ul>
<p>FIXME: add proof of work (not defined yet)</p>
<p>The <code>ID_PREFIX</code> is the first 32 bytes of the record id</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../filter/" class="btn btn-neutral float-left" title="Filter"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../tag_types/" class="btn btn-neutral float-right" title="Tag Type Registry">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  <div>
    <i>Steve Farroll edition</i>
  </div>
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../filter/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../tag_types/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
