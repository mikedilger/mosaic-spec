<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Record Format - Mosaic</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
        <link href="../style.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Record Format";
        var mkdocs_page_input_path = "record.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="..">
          <img src="../img/favicon-96x96.png" class="logo" alt="Logo"/>
        </a><div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
      <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Mosaic Introduction</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../status/">Status and Development</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Mosaic Core</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" >Identity</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../cryptography/">Cryptography</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../identity/">Identity</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../bootstrap/">Bootstrap</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" >Record Type</a>
    <ul class="current">
                <li class="toctree-l2"><a class="reference internal" href="../timestamps/">Timestamps</a>
                </li>
                <li class="toctree-l2 current"><a class="reference internal current" href="#">Record Format</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../human_readable_content/">Human Readable Content</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../core_tags/">Core Tags</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../reference/">References</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Core Records</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../keyschedule/">Key Schedule Record</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../profile/">Profile Record</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Protocol</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../filter/">Filter</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../protocol/">Core Protocol</a>
                </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" >Registries</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../tag_types/">Tag Type Registry</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../kinds/">Record Kind Registry</a>
                </li>
    </ul>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mosaic Accessory</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../human_encodings/">Human Encodings</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Mosaic Transport</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../websockets/">WebSockets</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../webtransport/">WebTransport</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Extensions</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../sync_protocol_extension/">Sync Protocol Extension</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Applications</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" >Mosaic Social media</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../microblog/">Microblogging</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../blog/">Blog</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../reply_comment/">Reply Comment</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../chat/">Chat</a>
                </li>
    </ul>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">Mosaic</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Mosaic Core</li>
          <li class="breadcrumb-item">Record Type</li>
      <li class="breadcrumb-item active">Record Format</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="record">Record</h1>
<p><status>PAGE STATUS: draft</status></p>
<p>A record is a datum within Mosaic. All datums are records.</p>
<h2 id="notation">Notation</h2>
<p>Byte slice notation <code>[m:n]</code> indicates the bytes including <code>m</code> up to and
including the byte <code>n-1</code> but not including the byte <code>n</code>. For example <code>[8:12]</code>
represents bytes 8, 9, 10 and 11.</p>
<h2 id="maximum-size">Maximum Size</h2>
<p>The maximum size of a record is 1 mebibyte (1,048,576 bytes).</p>
<p>This is specified so that length fields inside of records can be of a defined
fixed number of bits and so that software can make reasonable decisions about
buffer sizes.</p>
<h2 id="layout">Layout</h2>
<p>Note that records are laid out in a way to provide 64-bit alignment.</p>
<pre><code class="language-text">            1   2   3   4   4   5   6
    0   8   6   4   2   0   8   6   4
 0  +-------------------------------+
    | Signature 1/8                 |
 8  +-------------------------------+
    | Signature 2/8                 |
 16 +-------------------------------+
    | Signature 3/8                 |
 24 +-------------------------------+
    | Signature 4/8                 |
 32 +-------------------------------+
    | Signature 5/8                 |
 40 +-------------------------------+
    | Signature 6/8                 |
 48 +-------------------------------+
    | Signature 7/8                 |
 56 +-------------------------------+
    | Signature 8/8                 |
 64 +-------------------------------+ &lt;-----|
    | BE Timestamp           | Hash |
 72 +-------------------------------+       |
    | Hash 2/6                      |       |
 80 +-------------------------------+       |
    | Hash 3/6                      |  I    |
 88 +-------------------------------+  D    |
    | Hash 4/6                      |       |
 96 +-------------------------------+       |
    | Hash 5/6                      |       |
104 +-------------------------------+       |
    | Hash 6/6                      |       |
112 +-------------------------------+ &lt;-----|
    | Signing public key, 1/4       |
120 +-------------------------------+
    | Signing public key, 2/4       |
128 +-------------------------------+
    | Signing public key, 3/4       |
136 +-------------------------------+
    | Signing public key, 4/4       |
144 +-------------------------------+ &lt;-----|
    | Orig BE Timestamp     | Kind  |       |
152 +-------------------------------+       |
    | Nonce                         |   A   |
160 +-------------------------------+   D   |
    | Author public key, 1/4        |   D   |
168 +-------------------------------+   R   |
    | Author public key, 2/4        |   E   |
176 +-------------------------------+   S   |
    | Author public key, 3/4        |   S   |
184 +-------------------------------+       |
    | Author public key, 4/4        |       |
192 +-------------------------------+ &lt;-----|
    | Flags | Timestamp             |
200 +-------------------------------+
    |AppFlgs| Len_t | Len_p         |
208 +-------------------------------+
    | Tags...                       |
    |                   .. +PADDING |
  ? +-------------------------------+
    | Payload ...                   |
    |                   .. +PADDING |
  ? +-------------------------------+
</code></pre>
<h2 id="fields">Fields</h2>
<p>Records contain the following fields.</p>
<p>See the <a href="#layout">layout</a> section for the binary layout of these fields within
a record.</p>
<h3 id="signature">Signature</h3>
<p>64 bytes at <code>[0:64]</code></p>
<p>The signature field is the EdDSA ed25519ph signature of the record
produced using the <a href="#construction">construction</a> procedure.</p>
<h3 id="id">Id</h3>
<p>48 bytes at <code>[64:112]</code></p>
<p>This ID field is produced using the <a href="#construction">construction</a>
procedure.</p>
<h3 id="signing-public-key">Signing Public Key</h3>
<p>32 bytes at <code>[112:144]</code></p>
<p>This is the public key of the signing keypair, which is usually a subkey under
the author's master keypair (but theoretically could be delegated in some other
fashion in the future). This is represented in 32 bytes (256 bits).</p>
<h3 id="orig-be-timestamp">Orig BE Timestamp</h3>
<p>6 bytes at <code>[144:150]</code></p>
<p>This is the original timestamp represented in 6 bytes (48 bits) according
to <a href="../timestamps/">timestamps</a>, except in big-endian format.</p>
<p>If the record is not a replacement of another record (the usual case)
this is the same value as <a href="#timestamp">Timestamp</a>.</p>
<p>If the record is a replacement of another record, it copies the address
from the original record which will fill this with the original record
timestamp.</p>
<p>Rationale:</p>
<ul>
<li>By putting the timestamp at the front of the address, addresses sort in
  time order and group temporally (for database performance).</li>
</ul>
<h3 id="kind">Kind</h3>
<p>2 bytes at <code>[150:152]</code></p>
<p>This is the <a href="../kinds/">kind</a> of the record which determines the application
this record is part of, which then determines the nature of the non-core tags
and the payload. This is represented in 2 bytes (16 bits) as an
unsigned integer, little-endian.</p>
<h3 id="nonce">Nonce</h3>
<p>8 bytes at <code>[152:160]</code> which are randomly generated by the author.
This keeps addresses unique.</p>
<h3 id="author-public-key">Author Public Key</h3>
<p>32 bytes at <code>[160:192]</code></p>
<p>This is the identity of the author, expressed as a public key from their master
EdDSA ed25519 keypair, which is represented in 32 bytes (256 bits).</p>
<h3 id="flags">Flags</h3>
<p>2 bytes at <code>[192:194]</code></p>
<ul>
<li>0x01 ZSTD - The payload is compressed with Zstd</li>
<li>0x02 FROM_AUTHOR - Servers SHOULD only accept the record from the author (requiring authentication)</li>
<li>0x04 TO_RECIPIENTS - Servers SHOULD only serve the record to people tagged (requiring authentication)</li>
<li>0x08 NO_BRIDGE - Bridges SHOULD NOT propogate the record to other networks (nostr, mastodon, etc)</li>
<li>0x10 EPHEMERAL - The record is ephemeral; Servers should serve it to current subscribers and not keep it.</li>
<li>0x20 - RESERVED and MUST be 0</li>
<li>0x80, 0x40 - Signature scheme:<ul>
<li>00 - (default) EdDSA ed25519</li>
<li>01 - (nostr) secp256k1 Schnorr</li>
<li>10 - RESERVED</li>
<li>11 - RESERVED</li>
<li>NOTE: This only affects the signing key and the signature. The hash is
  always created with BLAKE3, and the master key is always EdDSA
  ed25519. This enables using nostr keys as subkeys.</li>
</ul>
</li>
<li>All other bits - RESERVED and MUST be 0</li>
</ul>
<h3 id="timestamp">Timestamp</h3>
<p>6 bytes at <code>[194:200]</code></p>
<p>This is a timestamp represented in 6 bytes (48 bits) according to
<a href="../timestamps/">timestamps</a>.</p>
<p>If this record replaces a previous record, this timestamp MUST be larger
than <a href="#orig-be-timestamp">Orig Timestamp</a>.</p>
<p>Rationale:</p>
<ul>
<li>It might seem like we have too many timestamps. But we need a timestamp
  of the current record, separate from the address, and which gets
  hashed by the hashing algorithm (the timestamp in the ID was not part
  of the hashing input).</li>
</ul>
<h3 id="appflgs">AppFlgs</h3>
<p>2 bytes at <code>[200:202]</code></p>
<p>These are bitflags reserved for use by the specific application based on
the <a href="#kind">kind</a>.</p>
<h3 id="len_t">Len_t</h3>
<p>2 bytes at <code>[202:204]</code> representing the length of the tags section in bytes
as an unsigned integer in little-endian format.</p>
<p>This represents the exact length of the tags section, not counting padding
at the end to achieve 64-bit alignment.</p>
<p>The maximum tags section length is 65536 bytes.</p>
<h3 id="len_p">Len_p</h3>
<p>4 bytes at <code>[204:208]</code> representing the length of the payload section in
bytes as an unsigned integer in little-endian format.</p>
<p>This represents the exact length of the payload section, not counting padding
at the end to achieve 64-bit alignment.</p>
<p>The maximum payload section length is 1_048_384 bytes.</p>
<h3 id="tags">Tags</h3>
<p>Varying bytes at <code>[208:208+Len_t]</code></p>
<p>These are searchable key-value tags.</p>
<p>Unlike nostr tags, all of these are searchable. If an application requires
unsearchable tags, these can be defined within that application's payload.</p>
<p>Tags are laid out as follows:</p>
<pre><code class="language-text">0           2         3         256 max
+-----------+---------+----------+
| type      | length  | value ...|
+-----------+---------+----------+
</code></pre>
<p>Each tag has a 2-byte (16 bit) type <code>[0:2]</code>, a 1-byte (8 bit) length <code>[2:3]</code>,
and a value that is at most 253 bytes long <code>[3:]</code>.</p>
<p>Tags only have one value.</p>
<p>The tags section is padded out to 64-bit alignment.</p>
<p>The maximum tags section length is 65536 bytes.</p>
<p>Tag types are documented at <a href="../tag_types/">Tag Type Registry</a> and
the tags are defined at <a href="../core_tags/">Core Tags</a>.</p>
<p>Rationale:</p>
<ul>
<li>Tag values should not be too large as they need to be indexed by relays.</li>
<li>Constraining the value to 253 bytes allows an entire TLV (with 16-bit
  type and 8-bit length) to fit within 256 bytes.</li>
</ul>
<h3 id="payload">Payload</h3>
<p>Varying bytes at <code>[208+Len_t:208+Len_t+Len_p].</code></p>
<p>Payload is opaque (at this layer of specification) application-specific data.</p>
<p>The payload section is padded out to 64-bit alignment.</p>
<p>The maximum payload section length is 1_048_384 bytes</p>
<h1 id="construction">Construction</h1>
<ol>
<li>Fill in all the data from <code>[112:]</code>.</li>
<li>Take a BLAKE3 hash of <code>[112:]</code>, unkeyed, and extend to 64 bytes
   of output using BLAKE3's <code>finalize_xof()</code> function. This does not
   directly go into the record.</li>
<li>Generate EdDSA ed25519ph pre-hashed signature of that 512-bit hash
   using the Signing private key, and providing the context string
   of "Mosaic". NOTE: ed25519 calls for a SHA-512 hash, but we use
   a BLAKE3 hash instead. Place the signature at bytes <code>[0:64]</code>.</li>
<li>Copy the first 48 bytes of the hash to <code>[64:112]</code>.</li>
<li>Write the timestamp as a 48-bit unsigned big-endian overtop of the
   first 6 bytes of the hash <code>[64:70]</code>.</li>
</ol>
<p>Rationale:</p>
<ul>
<li>EdDSA specifies SHA-512, but BLAKE3 is faster especially for longer
  messages, and EdDSA works just fine with it.</li>
<li>We provide a context so that users cannot be tricked by one application
  into signing content for a different application (in case users think
  they can use the same keypair for every application).</li>
<li>In order for IDs to sort in time order, and to group temporally (for
  database performance) we start them with the timestamp.</li>
<li>We want the ID to have at least 32 bytes of hash, and with the timestamp
  overwrite part we extended it.</li>
<li>This makes IDs 48-bytes long, which conveniently matches the length of
  addrs.</li>
</ul>
<h1 id="validation">Validation</h1>
<p>Records MUST be fully validated by clients.</p>
<p>Records MUST be fully validated by servers except for the
steps marked CLIENTS ONLY.</p>
<p>Validation steps</p>
<ol>
<li>The length must be between 208 and 1048576 bytes.</li>
<li>The length must equal 208 + Len_t + Len_p.</li>
<li>The Signing public key must be validated according to the
   <a href="../cryptography/">cryptography</a> key validation checks.</li>
<li>The Author public key must be validated according to the
   <a href="../cryptography/">cryptography</a> key validation checks.</li>
<li>CLIENTS ONLY: The Signing public key must be verified to be
   a non-revoked subkey of the Author via the Author's
   <a href="../bootstrap/">bootstrap</a>.</li>
<li>Take a BLAKE3 hash of <code>[112:]</code>, unkeyed, and extend to
   64 bytes of output using BLAKE3's <code>finalize_xof()</code> function.</li>
<li>Verify the hash: Compare bytes <code>[6:48]</code> of this hash with bytes
   <code>[70:112]</code> of the record. They MUST match.</li>
<li>Verify the ID timestamp: bytes <code>[64:70]</code> taken as a big-endian
   48-bit unsigned integer must equal bytes <code>[194:200]</code> taken as a
   little-endian unsigned 48-bit integer.</li>
<li>Verify the signature: The signature must be a valid EdDSA ed25519
   signature of the hash taken in step 6 with the signing public key.</li>
<li>The timestamp and the orig timestamp must be validated according to
    <a href="../timestamps/">timestamps</a>.</li>
<li>All reserved flags must be set to 0.</li>
<li>CLIENTS ONLY: Application specific validation should be performed.</li>
</ol>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../timestamps/" class="btn btn-neutral float-left" title="Timestamps"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../human_readable_content/" class="btn btn-neutral float-right" title="Human Readable Content">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  <div>
    <i>Steve Farroll edition</i>
  </div>
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../timestamps/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../human_readable_content/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
      <script src="../search/main.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
